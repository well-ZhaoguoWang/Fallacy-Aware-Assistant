<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Posts &amp; Comments Viewer</title>
<style>
  :root{
    --primary:#1677ff;
    --bg-card:#f7f9fc;
    --bg-comment:#fff;
    --radius:12px;
    --shadow:0 2px 6px rgba(0,0,0,.06)
  }
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;line-height:1.6;}
  header{background:var(--primary);color:#fff;padding:16px;display:flex;flex-wrap:wrap;align-items:center;gap:12px;}
  header h2{margin:0;font-size:1.3rem;flex:1;}
  button{border:none;border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;box-shadow:var(--shadow);transition:.2s all}
  button:not(:disabled){background:#fff;color:var(--primary);}
  button:disabled{background:#e7ecf6;color:#9aa0b5;cursor:not-allowed;}
  button:hover:not(:disabled){background:#f4f7ff;}
  main{max-width:880px;margin:24px auto;padding:0 16px;}
  .card{background:var(--bg-card);padding:20px 24px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:28px;}
  .card h1{margin-top:0;font-size:1.7rem;line-height:1.3;}
  .meta{font-size:.9rem;color:#666;margin-bottom:12px;}
  .content{background:#fff;padding:18px 20px;border-radius:var(--radius);}
  .content blockquote{background:#eef5ff;border-left:4px solid var(--primary);margin:12px 0;padding:10px 14px;border-radius:8px;}
  .comments-title{font-size:1.25rem;font-weight:600;margin-bottom:12px;}
  .comment{background:var(--bg-comment);padding:16px 18px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px;}
  .comment header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .badge{padding:2px 8px;font-size:.75rem;border-radius:8px;font-weight:600;color:#fff;text-transform:capitalize;}
    .slippery{background:#d4380d;}
    .authority{background:#722ed1;}
    .tradition{background:#d46b08;}
    .worseproblems{background:#0958d9;}
    .none{background:#777;}
  .nav-btns{display:flex;justify-content:center;gap:12px;margin:32px 0;}
  details pre{background:#111;color:#0f0;padding:14px;border-radius:var(--radius);overflow-x:auto;font-size:.8rem;margin:0;}
  /* ---------- Added: analysis box & loading animation ---------- */
  .analysis-box{margin-top:10px;background:#f4f7ff;padding:12px;border-radius:var(--radius);font-size:.9rem;}
  .analysis-box.loading{opacity:.6;font-style:italic;}
  /* 1) Spinning circle */
  @keyframes spin{to{transform:rotate(360deg);}}
  .analysis-box.loading::before{
    content:'';
    display:inline-block;
    width:14px;height:14px;
    border-radius:50%;
    border:3px solid var(--primary);
    border-top-color:transparent;
    margin-right:8px;
    animation:spin .8s linear infinite;
    vertical-align:middle;
  }
  /* 2) Bouncing dots */
  @keyframes dots{
    0%{content:'‚Ä¢';}
    33%{content:'‚Ä¢ ‚Ä¢';}
    66%{content:'‚Ä¢ ‚Ä¢ ‚Ä¢';}
  }
  .loading-text::after{
    content:'‚Ä¢';
    margin-left:4px;
    animation:dots 1s steps(3,end) infinite;
  }
</style>
</head>
<body>
<header>
  <h2>Posts &amp; Comments Viewer</h2>
  <button id="browseBtn" title="Open JSON file"> üìÇ </button>
  <input type="file" id="fileInput" accept=".json" style="display:none;">
</header>

<main id="app"></main>

<!-- Optional: markdown-it for rendering advice_md -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>

<script>
/* ====== Base variables ====== */
const API_BASE   = "http://localhost:5000";          // Change if your backend is hosted elsewhere
const ENDPOINT   = API_BASE + "/moderate";
const app        = document.getElementById('app');
const browseBtn  = document.getElementById('browseBtn');
const fileInput  = document.getElementById('fileInput');

const fallacyClass = {
  'slippery slope':'slippery',
  'appeal to authority':'authority',
  'appeal to tradition':'tradition',
  'appeal to worse problems':'worseproblems',
  'none':'none'
};

let posts=[],current=0;

/* ====== Try to load post.json by default (optional) ====== */
fetch('./post.json').then(r=>r.ok?r.json():Promise.reject()).then(init).catch(()=>{});

/* ====== Open local file ====== */
browseBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{init(JSON.parse(ev.target.result));}
    catch(err){alert('Failed to parse JSON: '+err);}
  };
  reader.readAsText(f,'utf-8');
});

/* ====== Init render ====== */
function init(list){
  if(!Array.isArray(list)){alert('JSON must be an array!');return;}
  posts=list;current=0;render();
}
function prev(){if(current>0){current--;render();}}
function next(){if(current<posts.length-1){current++;render();}}

/* ---------- Build comment tree ---------- */
function buildCommentTree(comments){
  const map=new Map();
  comments.forEach(c=>map.set(String(c.id),{...c,children:[]}));
  comments.forEach(c=>{
    if(c.respond_to){
      const parent=map.get(String(c.respond_to));
      parent && parent.children.push(map.get(String(c.id)));
    }
  });
  return comments.filter(c=>!c.respond_to).map(c=>map.get(String(c.id)));
}

/* ---------- Call backend analysis (with loading animation) ---------- */
async function analyzeComment(postText, commentNode, badgeEl, analysisBox, btn){
  btn.disabled = true;

  /* ‚Äî Start loading ‚Äî */
  analysisBox.classList.add("loading");
  analysisBox.innerHTML = `<span class="loading-text">Processing</span>`;

  try{
    const res = await fetch(ENDPOINT,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        news_text:   postText,
        comment_text:commentNode.comment,
        language:    "en"
      })
    });
    if(!res.ok) throw new Error(res.status+" "+res.statusText);
    const data = await res.json();
    if(!data.ok) throw new Error(data.msg||"API returned error");

    // Support both structured objects and plain-string payloads
    const payload = data.data;

    // Update badge (best-effort)
    let falKey = 'none';
    if (payload && typeof payload === 'object' && payload.fallacy) {
      falKey = String(payload.fallacy).toLowerCase();
    }
    badgeEl.textContent = falKey;
    Object.values(fallacyClass).forEach(c=>badgeEl.classList.remove(c));
    badgeEl.classList.add(fallacyClass[falKey]||"none");

    // Update analysis panel
    if (payload && typeof payload === 'object') {
      analysisBox.innerHTML = `
        <div><strong>type </strong>${payload.fallacy ?? '‚Äî'}</div>
        <div><strong>reason </strong>${payload.reason ?? '‚Äî'}</div>
        <div><strong>suggestion </strong>${
          payload.advice_md
            ? `<span class="advice-md"></span>`
            : (payload.advice ?? '‚Äî')
        }</div>
      `;
      if(payload.advice_md){
        const md = window.markdownit({linkify:true});
        analysisBox.querySelector('.advice-md').innerHTML = md.render(payload.advice_md);
      }
    } else {
      // Plain string result
      analysisBox.textContent = payload ?? '‚Äî';
    }

  }catch(err){
    analysisBox.innerHTML = `‚ùå ${err.message||err}`;
  }finally{
    /* ‚Äî End loading ‚Äî */
    analysisBox.classList.remove("loading");
    btn.disabled = false;
  }
}

/* ---------- Recursive comment render ---------- */
function renderComment(node,postText,level=0){
  const div=document.createElement('div');
  div.className='comment';
  div.style.marginLeft=`${level*24}px`;

  const badgeClass = fallacyClass[node.fallacy?.toLowerCase?.()] || 'none';

  div.innerHTML=`
    <header>
      <span>ID #${node.id}</span>
      <span class="badge ${badgeClass}">${node.fallacy ?? 'none'}</span>
    </header>
    <p>${node.comment}</p>
    <button class="analyse-btn" title="Analyze this comment">üîç</button>
    <div class="analysis-box"></div>
  `;

  const badgeEl      = div.querySelector('.badge');
  const analysisBox  = div.querySelector('.analysis-box');
  const analyseBtn   = div.querySelector('.analyse-btn');
  analyseBtn.addEventListener('click',()=>analyzeComment(postText,node,badgeEl,analysisBox,analyseBtn));

  if(node.children?.length){
    node.children.forEach(ch=>div.appendChild(renderComment(ch,postText,level+1)));
  }
  return div;
}

/* ---------- Main render ---------- */
function render(){
  if(!posts.length){app.innerHTML='<p style="color:red;">No data</p>';return;}
  const p=posts[current];
  app.innerHTML='';

  const card=document.createElement('section');
  card.className='card';
  card.innerHTML=`
    <h1>${p.title ?? 'Untitled'}</h1>
    <p class="meta">üÜî ${p.id ?? '-'} ¬∑ üñãÔ∏è ${p.author ?? 'Unknown'} ¬∑ üìÖ ${p.date ?? ''}</p>
    <div class="content">${p.content ?? ''}</div>`;
  app.appendChild(card);

  if(Array.isArray(p.comments)&&p.comments.length){
    const wrap=document.createElement('section');
    wrap.innerHTML=`<h3 class="comments-title"> üí¨ (${p.comments.length})</h3>`;
    const tree=buildCommentTree(p.comments);
    tree.forEach(root=>wrap.appendChild(renderComment(root,p.content)));
    app.appendChild(wrap);
  }

  const nav=document.createElement('div');
  nav.className='nav-btns';
  nav.innerHTML=`
    <button id="prevBtn" ${current===0?'disabled':''} title="Previous">‚Äπ</button>
    <span style="align-self:center;">${current+1} / ${posts.length}</span>
    <button id="nextBtn" ${current===posts.length-1?'disabled':''} title="Next">‚Ä∫</button>`;
  app.appendChild(nav);
  document.getElementById('prevBtn').onclick=prev;
  document.getElementById('nextBtn').onclick=next;

  const dbg=document.createElement('details');
  dbg.innerHTML=`<summary>Origin JSON</summary><pre>${JSON.stringify(p,null,2)}</pre>`;
  app.appendChild(dbg);

  window.scrollTo({top:0,behavior:'smooth'});
}

/* ====== CORS note ======
If the frontend and Flask are on different origins (port/host),
enable CORS in Flask:

  from flask_cors import CORS
  CORS(app)

Otherwise the browser will block requests due to CORS.
========================== */
</script>
</body>
</html>
